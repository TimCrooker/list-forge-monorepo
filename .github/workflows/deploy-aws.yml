name: Deploy to AWS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  # ============================================================================
  # BUILD JOBS - Run in parallel
  # ============================================================================

  build-api:
    name: Build API
    runs-on: ubuntu-latest
    outputs:
      image-uri: ${{ steps.build.outputs.image-uri }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push API image
        id: build
        uses: ./.github/actions/docker-build-push
        with:
          dockerfile: Dockerfile.api
          image-name: listforge-api
          ecr-registry: ${{ steps.login-ecr.outputs.registry }}

  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    outputs:
      image-uri: ${{ steps.build.outputs.image-uri }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Web image
        id: build
        uses: ./.github/actions/docker-build-push
        with:
          dockerfile: Dockerfile.web
          image-name: listforge-web
          ecr-registry: ${{ steps.login-ecr.outputs.registry }}
          build-args: |
            VITE_API_URL=https://api.list-forge.ai

  build-landing:
    name: Build Landing
    runs-on: ubuntu-latest
    outputs:
      image-uri: ${{ steps.build.outputs.image-uri }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Landing image
        id: build
        uses: ./.github/actions/docker-build-push
        with:
          dockerfile: Dockerfile.landing
          image-name: listforge-landing
          ecr-registry: ${{ steps.login-ecr.outputs.registry }}
          build-args: |
            VITE_APP_URL=https://app.list-forge.ai
            VITE_API_URL=https://api.list-forge.ai

  # ============================================================================
  # DEPLOY JOBS - Run after respective builds complete
  # ============================================================================

  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs: build-api
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to App Runner
        uses: ./.github/actions/deploy-apprunner
        with:
          service-arn: ${{ secrets.APP_RUNNER_API_ARN }}
          aws-region: ${{ env.AWS_REGION }}

  deploy-web:
    name: Deploy Web
    runs-on: ubuntu-latest
    needs: build-web
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to App Runner
        uses: ./.github/actions/deploy-apprunner
        with:
          service-arn: ${{ secrets.APP_RUNNER_WEB_ARN }}
          aws-region: ${{ env.AWS_REGION }}

  deploy-landing:
    name: Deploy Landing
    runs-on: ubuntu-latest
    needs: build-landing
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to App Runner
        uses: ./.github/actions/deploy-apprunner
        with:
          service-arn: ${{ secrets.APP_RUNNER_LANDING_ARN }}
          aws-region: ${{ env.AWS_REGION }}

  # ============================================================================
  # SUMMARY JOB - Run after all deployments complete
  # ============================================================================

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-web, deploy-landing]
    if: always()
    steps:
      - name: Check deployment status
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-api.result }}" = "success" ]; then
            echo "✅ API deployment: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ API deployment: ${{ needs.deploy-api.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.deploy-web.result }}" = "success" ]; then
            echo "✅ Web deployment: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Web deployment: ${{ needs.deploy-web.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.deploy-landing.result }}" = "success" ]; then
            echo "✅ Landing deployment: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Landing deployment: ${{ needs.deploy-landing.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any deployment failed
        if: needs.deploy-api.result != 'success' || needs.deploy-web.result != 'success' || needs.deploy-landing.result != 'success'
        run: exit 1
